<html>

<head>
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.3/d3.min.js"></script>
  <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.2.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore-min.js"></script>

  <style type="text/css">
    .poi circle {
      cursor: pointer;
      fill: #666;
      stroke: white;
      stroke-width: 5px;
      -webkit-transition: fill 0.5s ease;
    }
    circle.activity{
      fill: rgb(130, 189, 130);
      stroke: white;
      stroke-width: 5px;
    }

    .mainpoi{
      cursor: pointer;
      fill: #666;
      stroke: white;
      stroke-width: 5px;
      -webkit-transition: fill 1s ease;
    }

    .node text {
      font-size: 11px;
    }
    path.sidelinks {
      fill: none;
      stroke: #ccc;
      stroke-width: 10px;
      stroke-linecap: round;
      -webkit-transition: 1s ease all;
    }
    path.sidelinks.active {
      stroke-dashoffset: 0px !important;
    }
    circle.showhelp {
      fill: rgb(226, 178, 90);
    }
    circle.showadvanced {
      fill: rgb(174, 97, 174);
    }
    line.mainpath {
      stroke-width: 20px;
      stroke: #aaa;
    }
  </style>
</head>

<body>
  <script type="text/javascript">
  var activity = [];


  //FAKE EVERYTHING!
  var names = ["Modeling with periodic functions",
    "Constructing linear and exponential functions",
    "Modeling with periodic functions 2",
    "Addition and subtraction word problems within 100: Level 4",
    "Addition and subtraction word problems within 100: Level 1",
    "Comparing linear functions applications",
    "Addition and subtraction word problems within 100: Level 3",
    "Making line plots, bar graphs, and picture graphs",
    "Interpreting scale drawings",
    "Constructing 2D figures",
    "Adding and subtracting negative numbers word problems",
    "Circles and Pythagorean identities",
    "Solving for unknown angles",
    "Understanding addition and subtraction on the number line",
    "Constructing proportions to solve application problems",
    "Area, volume, and surface area",
    "Rules for multiplying and dividing negative numbers",
    "Interpreting linear expressions",
    "Addition and subtraction word problems within 100: Level 2",
    "Linear equation word problems",
    "Operations with rational numbers",
    "Simple probability",
    "Understanding addition and subtraction with negative numbers",
    "Variation in samples",
    "Manipulating linear expressions with rational coefficients",
    "Comparing populations",
    "Multi-step rational number word problems",
    "Probability models",
    "Finding probability",
    "Constructing and comparing proportional relationships",
    "Qualitatively defining rigid transformations",
    "Performing transformations on the coordinate plane",
    "Transforming polygons",
    "Symmetry of two-dimensional shapes",
    "Quantitatively defining rigid transformations",
    "Dilations",
    "Performing transformations on the coordinate plane",
    "Trigonometric functions and side ratios in right triangles",
    "Exploring rigid transformations and congruence",
    "Non-right triangle proofs"
  ];

  function addChild(depth) {
    depth -= 1;
    var name = names[~~(Math.random() * names.length)];
    var children = [];
    var me = {};
    me.id = _.uniqueId();
    for (var i = 0; i < depth; i++) {
      if (Math.random() > 0.5) {
        children.push(addChild(depth));
      }
    }

    me.name = name;
    if (children.length > 0) {
      me.children = children;
    }

    //Add Fake Activity
    fakeActivity(me);

    return me;
  }

  //Fake Activity
  function fakeActivity(poi) {
    var date = new Date();
    date.setDate(date.getDate() - 1);
    date.setHours(~~(Math.random() * 23));
    activity.push({
      "id": poi.id,
      "description": {
        "subject": {}
      },
      "startdate": date.getTime(),
      "totalQuestions": 4,
      "totalCorrect": 8,
      "totalWrong": 0
    });
  }
  //Fake Main Pois
  var pois = {
    children: _.range(3).map(function(v, i) {
      var poi = {
        id: _.uniqueId()
      };
      fakeActivity(poi);
      return poi;
    })
  };

  //Fake Branches
  for (var i = 0; i < pois.children.length; i++) {
    var root = addChild(4);
    pois.children[i].help = root;
    root = addChild(4);
    pois.children[i].advanced = root;
  }
  activity = _.sample(activity, activity.length/2);

  //FAKEING COMPLETE


    function drawMap(pois, activity){
      function toggleChildren(d, force) {
        if(force !== undefined){
          if(force){
            d.display = 'block';
            d3.selectAll(d.childlinks).attr('class', 'sidelinks active');
          }else{
            d.display = 'none';
            d3.selectAll(d.childlinks).attr('class', 'sidelinks');
          }
          if (d.children) {
            _(d.children).each(function(v) {
              toggleChildren(v, force)
            });
          }

        }else{
          if (!d.cdis) {
            d.display = 'none';
            d3.selectAll(d.childlinks).attr('class', 'sidelinks');
            if (d.children) {
              _(d.children).each(function(v) {
                toggleChildren(v, d.cdis)
              });
            }
          } else {
            d.display = 'block';
            d3.selectAll(d.childlinks).attr('class', 'sidelinks active');
          }
          d.cdis = !d.cdis
        }



        d3.selectAll('.poi')
          .style('display', function(d) {
            return d.display
        });
      }

      function addTree(origin, root, dir) {
        if (!dir) {
          dir = 1;
        }

        var vis = svg.append('g')
          .attr('transform', 'translate(' + (origin.y + treecenter) + ',' + origin.x + ')')

        root.tree = vis;
        var nodes = tree.nodes(root).reverse();
        _(nodes).each(function(d) {
          d.display = 'none';
          d.childlinks = [];

          if (d.depth === 0) {
            d.x = 110;
            d.y = 0;
          } else {
            d.y = dir * d.depth * 80 + (-10 * d.parent.children.indexOf(d))
          }
        });

        var nodeEnter = vis.selectAll('g.poi').data(nodes).enter()
        var poi = nodeEnter.append('g')
          .attr('id', function(d) {
            return 'poi_' + d.id;
          })
          .attr('class', 'poi')
          .style('display', 'none')
          .attr('transform', function(d) {
            return 'translate(' + d.y + ',' + d.x + ')';
          })
          .on('click', function(d) {
            if (d.children)
              _(d.children).each(function(c){
                toggleChildren(c);
              });
          });

        poi.append('circle')
          .attr('class', 'poicircle')
          .attr('r', 15)

        // poi.append('svg:text')
        //   .text(function(d) {
        //     return d.id;
        //   }).attr('fill', 'black')

        var links = vis.selectAll('path.sidelinks').data(tree.links(nodes)).enter().insert('svg:path', 'g')
          .attr('class', 'sidelinks')
          .attr('d', function(d) {
            return diagonal({
              source: d.source,
              target: d.target
            });
          }).call(function(d) {
            _(d).each(function(v, i) {
              _(v).each(function(w, i) {
                var length = w.getTotalLength();

                d3.select(w)
                  .attr('stroke-dasharray', length)
                  .attr('stroke-dashoffset', length)
                  .data()[0].target.childlinks.push(w)
              })
            });
          });
      }

      var m = [0, 0, 0, 0],
        width = 1000,
        height = 250 * pois.children.length,
        i = 0;

      var diagonal = d3.svg.diagonal().projection(function(d) {
        return [d.y, d.x];
      });
      var treecenter = 400;

      var svg = d3.select("body").append("svg:svg")
        .attr("width", width)
        .attr("height", height + 100)

      svg.append('line')
        .attr('class', 'mainpath')
        .attr('x1', treecenter + 50)
        .attr('y1', 100)
        .attr('x2', treecenter + 50)
        .attr('y2', height + 100)

      svg = svg.append('g')
        .attr('transform', 'translate(0, 100)');

      var tree = d3.layout.tree().size([220, 600]);
      var diagonal = d3.svg.diagonal().projection(function(d) {
        return [d.y, d.x];
      });

      var mainPath = d3.layout.tree().size([height, 50]);
      var nodes = mainPath.nodes(pois).reverse();

      _(nodes).each(function(d, i) {
        if (!d.depth) {
          nodes.splice(i, 1);
        }
      })

      var yoff = ((height / pois.children.length) * 0.5) - 15;

      _(pois.children).each(function(v, i) {
        addTree({
          x: v.x - yoff,
          y: v.y
        }, v.help, -1);
        addTree({
          x: v.x - yoff,
          y: v.y
        }, v.advanced, 1);
      });

      var nodeEnter = svg.append('g')
        .attr('transform', 'translate(' + treecenter + ', 0)')
        .selectAll('g.mainPath').data(nodes).enter()
      var poi = nodeEnter.append('g')
        .attr('id', function(d) {
          return 'poi_' + d.id;
        })
        .attr('transform', function(d) {
          return 'translate(' + d.y + ',' + d.x + ')';
        })


      poi.append('circle')
        .attr('class', 'showhelp')
        .attr('cx', -20)
        .attr('r', 15)
        .on('click', function(d) {
          if (d.help.children)
            _(d.help.children).each(function(c){
              toggleChildren(c, false);
            });
        });

      poi.append('circle')
        .attr('class', 'showadvanced')
        .attr('cx', 20)
        .attr('r', 15)
        .on('click', function(d) {
          if (d.advanced.children)
            _(d.advanced.children).each(function(c){
              toggleChildren(c, false)
            });
        });

      poi.append('circle')
        .attr('class', 'mainpoi poicircle')
        .attr('r', 18)
        .on('click', function(d) {
          if (d.help.children)
            _(d.help.children).each(function(d) {
              toggleChildren(d, true)
            });
          if (d.advanced.children)
            _(d.advanced.children).each(function(d) {
              toggleChildren(d, true)
            });
        });

    }






    drawMap(pois, activity);

    (function playActivity() {
      _(activity).each(function(v, i) {

        setTimeout(function() {
          var poi = d3.select('#poi_' + v.id);
          poi.select('circle.poicircle').attr('class', 'activity');
          var d = poi.data()[0];

          while (d.parent) {
            d.display = 'block';
            if(d.childlinks)
            d3.selectAll(d.childlinks).attr('class', 'sidelinks active');
            d = d.parent;
          }

          d3.selectAll('.poi')
            .style('display', function(d) {
              return d.display
            });
        }, 500 * i);


      })
    })();
  </script>
</body>

</html>
